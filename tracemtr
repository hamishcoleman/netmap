#!/bin/bash
#
# Given a list of IP addresses, use mtr to trace to each one and then
# draw a dot file

if [ -z "$1" ]; then
    echo need ip list file
    exit 1
fi
IPLIST="$1"

DOT=`date "+output-%s.dot"`

echo "# $0 $#" >$DOT
echo "graph G {" >>$DOT

grep -v "^#" $IPLIST |while read ip desc; do
    if [ -z "$ip" ]; then
        continue
    fi
    echo "Trace to $ip $desc" 1>&2

    if [ -n "$desc" ]; then
        echo "\"$ip\" [label=\"\\N\n$desc\"];"
    fi

    LAST=
    mtr --no-dns --report --report-cycles 2 --csv $ip | cut -d"," -f6 | while read j; do
        if [ "$j" = "???" ]; then
            LAST=
            continue
        fi
        if [ -n "$LAST" ]; then
            echo "\"$LAST\" -- \"$j\";"
        fi
        LAST="$j"
    done
done | sort | uniq >>$DOT

echo "}" >>$DOT

echo $DOT

